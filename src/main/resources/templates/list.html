<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Routes</title>
    <link th:href="@{/css/style.css}" rel="stylesheet" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  </head>
  <body>
    <header
      th:with="active='routes'"
      th:insert="~{fragments/navbar :: navbar}"
    ></header>

    <div class="flash">
      <div class="msg ok" th:if="${message}" th:text="${message}"></div>
      <div class="msg err" th:if="${error}" th:text="${error}"></div>
    </div>

    <section id="content">
      <h1>Routes</h1>

      <form class="filters" th:action="@{/routes}" method="get">
        <label>
          Name:
          <input type="text" name="name" th:value="${name}" />
        </label>
        <label>
          From location:
          <select name="fromId">
            <option value="">— any —</option>
            <option
              th:each="loc : ${locations}"
              th:value="${loc.id}"
              th:text="${loc.name}"
              th:selected="${fromId != null and fromId == loc.id}"
            ></option>
          </select>
        </label>
        <label>
          To location:
          <select name="toId">
            <option value="">— any —</option>
            <option
              th:each="loc : ${locations}"
              th:value="${loc.id}"
              th:text="${loc.name}"
              th:selected="${toId != null and toId == loc.id}"
            ></option>
          </select>
        </label>
        <button type="submit">Filter</button>
        <a class="button btn-secondary" th:href="@{/routes}">Reset</a>
      </form>

      <div class="controls-bar">
        <!-- Import button -->
        <form
          id="import-json-form"
          th:action="@{/imports/upload}"
          method="post"
          enctype="multipart/form-data"
          style="display: inline"
        >
          <button
            type="button"
            class="button btn-secondary"
            id="btn-import-json"
          >
            Import JSON…
          </button>

          <input
            id="file-import-json"
            type="file"
            name="file"
            accept="application/json,.json"
            hidden
          />
        </form>

        <div class="sort">
          Sort:
          <a
            th:href="@{/routes(sort='id,asc', name=${name}, fromId=${fromId}, toId=${toId})}"
            >ID ▲</a
          >
          |
          <a
            th:href="@{/routes(sort='id,desc', name=${name}, fromId=${fromId}, toId=${toId})}"
            >ID ▼</a
          >
          |
          <a
            th:href="@{/routes(sort='name,asc', name=${name}, fromId=${fromId}, toId=${toId})}"
            >Name ▲</a
          >
          |
          <a
            th:href="@{/routes(sort='name,desc',name=${name}, fromId=${fromId}, toId=${toId})}"
            >Name ▼</a
          >
        </div>
        <p>
          <a class="button btn-primary" th:href="@{/routes/new}"
            >Create new Route</a
          >
        </p>
      </div>

      <div class="pager" th:if="${routes.totalPages > 1}">
        <span
          th:text="'Page ' + ${routes.number + 1} + ' of ' + ${routes.totalPages}"
        ></span>
        <div>
          <a
            th:if="${routes.hasPrevious()}"
            th:href="@{/routes(page=${routes.number - 1}, size=${routes.size}, sort=${sort}, name=${name}, fromId=${fromId}, toId=${toId})}"
            >Prev</a
          >
          <a
            th:if="${routes.hasNext()}"
            th:href="@{/routes(page=${routes.number + 1}, size=${routes.size}, sort=${sort}, name=${name}, fromId=${fromId}, toId=${toId})}"
            >Next</a
          >
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Coord X</th>
            <th>Coord Y</th>
            <th>From</th>
            <th>To</th>
            <th>Distance</th>
            <th>Rating</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="routes-tbody">
          <tr th:each="r : ${routes}" th:attr="data-id=${r.id}">
            <td th:text="${r.id}"></td>
            <td th:text="${r.name}"></td>
            <td th:text="${r.coordinates != null ? r.coordinates.x : ''}"></td>
            <td th:text="${r.coordinates != null ? r.coordinates.y : ''}"></td>
            <td th:text="${r.from != null ? r.from.name : '-'}"></td>
            <td th:text="${r.to != null ? r.to.name : ''}"></td>
            <td th:text="${r.distance}"></td>
            <td th:text="${r.rating}"></td>
            <td
              th:text="${#dates.format(r.creationDate,'yyyy-MM-dd HH:mm')}"
            ></td>
            <td class="actions">
              <a class="button btn-secondary" th:href="@{|/routes/${r.id}|}"
                >View</a
              >
              <a class="button" th:href="@{|/routes/${r.id}/edit|}">Edit</a>
              <form th:action="@{|/routes/${r.id}/delete|}" method="post">
                <button
                  type="submit"
                  class="btn-danger"
                  th:onclick="|return confirm('Delete route #${r.id}?')|"
                >
                  Delete
                </button>
              </form>
            </td>
          </tr>
          <tr th:if="${#lists.isEmpty(routes)}" id="empty-row">
            <td colspan="10">No routes found</td>
          </tr>
        </tbody>
      </table>
    </section>

    <script th:src="@{/js/routes-live.js}"></script>
    <script th:src="@{/js/routes-import.js}"></script>
  </body>
</html>
